import { useState, useEffect } from 'react'
import { useRouter } from 'next/router'
import Link from 'next/link'
import { 
  collection, 
  query, 
  where, 
  getDocs, 
  orderBy 
} from 'firebase/firestore'
import { db } from '../firebaseConfig'
import toast from 'react-hot-toast'

// íƒ­ ì»´í¬ë„ŒíŠ¸ë“¤ import
import AnnouncementsTab from '../components/AnnouncementsTab'
import PhotosTab from '../components/PhotosTab'
import ScheduleTab from '../components/ScheduleTab'
import FeedbackTab from '../components/FeedbackTab'
import ParticipantsTab from '../components/ParticipantsTab'

export default function Dashboard() {
  const router = useRouter()
  const [user, setUser] = useState(null)
  const [project, setProject] = useState(null)
  const [schedules, setSchedules] = useState([])
  const [announcements, setAnnouncements] = useState([])


  const [loading, setLoading] = useState(true)
  const [activeTab, setActiveTab] = useState('announcements') // ê¸°ë³¸ íƒ­ì„ ê³µì§€ì‚¬í•­ìœ¼ë¡œ ì„¤ì •
  


  useEffect(() => {
    // ì‚¬ìš©ì ì„¸ì…˜ í™•ì¸
    const userSession = localStorage.getItem('userSession')
    if (!userSession) {
      router.push('/')
      return
    }

    try {
      const userData = JSON.parse(userSession)
      setUser(userData)
      setProject(userData.currentProject)
      loadProjectData(userData.currentProject.id, userData)
    } catch (error) {
      console.error('ì„¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:', error)
      router.push('/')
    }
  }, [router])

  const loadProjectData = async (projectId, userData) => {
    try {
      // ì¼ì • ë°ì´í„° ë¡œë“œ
      await loadSchedules(projectId)
      
      // ê³µì§€ì‚¬í•­ ë¡œë“œ
      await loadAnnouncements(projectId)
      

      

      
      setLoading(false)
    } catch (error) {
      console.error('í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error)
      toast.error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
      setLoading(false)
    }
  }

  const loadSchedules = async (projectId) => {
    try {
      // ì‚¬ìš©ì ì„¸ì…˜ì—ì„œ ê¶Œì—­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const userSession = localStorage.getItem('userSession')
      if (!userSession) {
        console.log('ì‚¬ìš©ì ì„¸ì…˜ ì—†ìŒ')
        setSchedules([])
        return
      }
      
      const userData = JSON.parse(userSession)
      const rawRegion = userData.region || userData.affiliation?.replace(/[^0-9]/g, '') || '1'
      const region = (rawRegion?.toString().match(/\d+/) || ['1'])[0]
      
      // ê°€ì´ë“œ ì¼ì • ê´€ë¦¬ì—ì„œ ì¼ì • ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const response = await fetch(`/api/schedule-management?region=${region}`)
      const result = await response.json()
      
      if (result.success && result.data && result.data.activities) {
        const processedSchedules = []
        const activities = result.data.activities
        
        Object.keys(activities).forEach(date => {
          const daySchedules = activities[date]
          
          // í•´ë‹¹ ë‚ ì§œì˜ ì¼ì •ë“¤ì„ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
          daySchedules.sort((a, b) => {
            const timeA = a.time || '00:00'
            const timeB = b.time || '00:00'
            return timeA.localeCompare(timeB)
          })
          
          // ê¸°ì¡´ ì¼ì •ë“¤ ì¶”ê°€
          daySchedules.forEach(schedule => {
            processedSchedules.push({
              id: `${date}_${schedule.time}`,
              date: date,
              time: schedule.time,
              activityName: schedule.activity,
              location: schedule.location,
              adminNotes: schedule.description || '',
              type: 'normal',
              hasResearchTask: schedule.activity?.includes('ì—°êµ¬') || schedule.activity?.includes('ê³¼ì œ') || false,
              isMeal: schedule.activity?.includes('ì¡°ì‹') || schedule.activity?.includes('ì¤‘ì‹') || schedule.activity?.includes('ì„ì‹') || schedule.activity?.includes('ì•„ì¹¨') || schedule.activity?.includes('ì ì‹¬') || schedule.activity?.includes('ì €ë…') || false
            })
          })
          
          // ë§ˆì§€ë§‰ ì¼ì • 1ì‹œê°„ í›„ì— ììœ ì‹œê°„ ì¶”ê°€
          if (daySchedules.length > 0) {
            const lastSchedule = daySchedules[daySchedules.length - 1]
            const lastTime = lastSchedule.time || '18:00'
            
            // ì‹œê°„ì„ ë¶„ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ 1ì‹œê°„ ì¶”ê°€
            const [hours, minutes] = lastTime.split(':').map(Number)
            const freeTimeHours = hours + 1
            const freeTime = `${freeTimeHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`
            
            processedSchedules.push({
              id: `auto_free_${date}`,
              date: date,
              time: freeTime,
              activityName: 'ğŸ—“ï¸ ììœ ì¼ì •',
              location: 'ììœ  ì„ íƒ',
              type: 'free',
              adminNotes: 'ììœ ë¡œìš´ ì‹œê°„ì„ ë§Œë½í•´ë³´ì„¸ìš”!',
              autoGenerated: true
            })
          }
        })
        
        setSchedules(processedSchedules)
      } else {
        // DBì— ë°ì´í„°ê°€ ì—†ì„ ë•ŒëŠ” ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
        setSchedules([])
      }
    } catch (error) {
      console.log('ì¼ì • ë¡œë“œ ì‹¤íŒ¨:', error)
      setSchedules([])
    }
  }

  const loadAnnouncements = async (projectId) => {
    try {
      // ì‚¬ìš©ì ì„¸ì…˜ì—ì„œ ê¶Œì—­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const userSession = localStorage.getItem('userSession')
      if (!userSession) {
        console.log('ì‚¬ìš©ì ì„¸ì…˜ ì—†ìŒ')
        setAnnouncements([])
        return
      }
      
      const userData = JSON.parse(userSession)
      const rawRegion = userData.region || userData.affiliation?.replace(/[^0-9]/g, '') || '1'
      const region = (rawRegion?.toString().match(/\d+/) || ['1'])[0]
      
      // ê³µì§€ì‚¬í•­ APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const response = await fetch(`/api/announcements?region=${region}`)
      const result = await response.json()
      
      if (result.success && result.data && result.data.length > 0) {
        // ê³µì§€ì‚¬í•­ ë°ì´í„°ë¥¼ ëŒ€ì‹œë³´ë“œ í˜•ì‹ì— ë§ê²Œ ë³€í™˜
        const formattedAnnouncements = result.data.slice(0, 5).map(announcement => ({
          id: announcement.id,
          date: announcement.date,
          content: announcement.content,
          author: announcement.createdBy,
          urgentLevel: announcement.urgentLevel || 'normal'
        }))
        setAnnouncements(formattedAnnouncements)
      } else {
        setAnnouncements([
          {
            id: 1,
            date: new Date().toISOString().split('T')[0],
            content: "ğŸ‰ ì•ˆë…•í•˜ì„¸ìš”! ì—°ìˆ˜ í”„ë¡œê·¸ë¨ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.",
            author: "ê°€ì´ë“œ",
            urgentLevel: "normal"
          }
        ])
      }
    } catch (error) {
      console.log('ê³µì§€ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨:', error)
      setAnnouncements([
        {
          id: 1,
          date: new Date().toISOString().split('T')[0],
          content: "ğŸ‰ ì•ˆë…•í•˜ì„¸ìš”! ì—°ìˆ˜ í”„ë¡œê·¸ë¨ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.",
          author: "ê°€ì´ë“œ",
          urgentLevel: "normal"
        }
      ])
    }
  }





  const handleLogout = () => {
    localStorage.removeItem('userSession')
    toast.success('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.')
    router.push('/')
  }

  const formatDate = (dateString) => {
    const date = new Date(dateString)
    return date.toLocaleDateString('ko-KR', {
      month: 'long',
      day: 'numeric',
      weekday: 'short'
    })
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="text-lg">ë°ì´í„° ë¡œë”© ì¤‘...</div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-100">
      {/* í—¤ë” */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-4">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">
                {project?.projectName}
              </h1>
              <p className="text-sm text-gray-600">
                {user?.name}ë‹˜ ({user?.affiliation})
              </p>
            </div>
            <button
              onClick={handleLogout}
              className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors text-sm"
            >
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div className="px-4 py-6 sm:px-0">
          
          {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
          <div className="mb-6">
            <div className="border-b border-gray-200">
              <nav className="-mb-px flex space-x-8">
                {[
                  { id: 'announcements', name: 'ê³µì§€+ì˜¤ëŠ˜', icon: 'ğŸ“¢' },
                  { id: 'schedule', name: 'ì „ì²´ ì¼ì •', icon: 'ğŸ“…' }
                ].map((tab) => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`py-2 px-1 border-b-2 font-medium text-sm ${
                      activeTab === tab.id
                        ? 'border-blue-500 text-blue-600'
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    }`}
                  >
                    {tab.icon} {tab.name}
                  </button>
                ))}
              </nav>
            </div>
          </div>

          {/* íƒ­ ë‚´ìš© */}
          {activeTab === 'announcements' && (
            <AnnouncementsTab 
              announcements={announcements}
              schedules={schedules}
              formatDate={formatDate}
            />
          )}

          {activeTab === 'schedule' && (
            <ScheduleTab 
              projectId={project?.id}
            />
          )}

        </div>
      </main>
    </div>
  )
}
