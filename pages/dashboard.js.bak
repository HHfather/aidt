import { useState, useEffect } from 'react'
import { useRouter } from 'next/router'
import Link from 'next/link'
import { 
  collection, 
  query, 
  where, 
  getDocs, 
  orderBy 
} from 'firebase/firestore'
import { db } from '../firebaseConfig'
import toast from 'react-hot-toast'

export default function Dashboard() {
  const router = useRouter()
  const [user, setUser] = useState(null)
  const [project, setProject] = useState(null)
  const [schedules, setSchedules] = useState([])
  const [announcements, setAnnouncements] = useState([])
  const [loading, setLoading] = useState(true)
  const [userStats, setUserStats] = useState({
    comments: 3,
    reactions: 12,
    photos: 2
  })
  const [teamRanking, setTeamRanking] = useState({
    currentRank: 1,
    totalTeams: 4,
    pointsToNext: 0,
    motivationMessage: ''
  })

  useEffect(() => {
    const userSession = localStorage.getItem('userSession');
    if (!userSession) {
      router.push('/');
      return;
    }

    try {
      const sessionData = JSON.parse(userSession);
      if (sessionData.isUser) {
        setUser(sessionData.user);
        setProject(sessionData.currentProject);
        // `schedules` ì»¬ë ‰ì…˜ ëŒ€ì‹  `currentProject`ì— ìˆëŠ” ìŠ¤ì¼€ì¤„ ë°ì´í„°ë¥¼ ì‚¬ìš©
        if (sessionData.currentProject && sessionData.currentProject.schedule) {
          const formattedSchedules = formatSchedules(sessionData.currentProject.schedule);
          setSchedules(formattedSchedules);
        } else {
          setSchedules([]); // ìŠ¤ì¼€ì¤„ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
        }
        setLoading(false);
      } else {
        // ì‚¬ìš©ìê°€ ì•„ë‹Œ ê²½ìš° (ì˜ˆ: ê°€ì´ë“œ, ê´€ë¦¬ì)
        toast.error("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
        router.push('/');
      }
    } catch (error) {
      console.error('ì„¸ì…˜ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
      toast.error("ì„¸ì…˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      router.push('/');
    }
  }, [router]);

  // ìŠ¤ì¼€ì¤„ ë°ì´í„° í¬ë§·íŒ… í•¨ìˆ˜
  const formatSchedules = (scheduleArray) => {
    if (!scheduleArray || scheduleArray.length === 0) return [];
    
    return scheduleArray.map((item, index) => ({
      id: `${item.date}-${index}`,
      date: item.date,
      time: item.time,
      activityName: item.activity,
      location: item.location,
      type: 'activity', // ê¸°ë³¸ ìœ í˜•ì„ 'activity'ë¡œ ì„¤ì •
      adminNotes: item.notes || '',
    }));
  };


  const loadProjectData = async (projectId, userData) => {
    try {
      // AI íŒŒì‹±ëœ ì¼ì • ë°ì´í„° ë¡œë“œ ì‹œë„
      let schedulesData = []
      
      try {
        // ê´€ë¦¬ìê°€ ì—…ë¡œë“œí•œ AI íŒŒì‹± íŒŒì¼ì—ì„œ ì¼ì • ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const uploadedFilesQuery = query(
          collection(db, 'uploadedFiles'),
          where('type', '==', 'schedule'),
          where('verified', '==', true),
          orderBy('uploadedAt', 'desc')
        )
        const uploadedFilesSnapshot = await getDocs(uploadedFilesQuery)
        
        if (!uploadedFilesSnapshot.empty) {
          const latestScheduleFile = uploadedFilesSnapshot.docs[0].data()
          
          if (latestScheduleFile.parsedData && latestScheduleFile.parsedData.schedules) {
            // AI íŒŒì‹±ëœ ë°ì´í„°ë¥¼ ëŒ€ì‹œë³´ë“œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            schedulesData = latestScheduleFile.parsedData.schedules.map((schedule, index) => ({
              id: `parsed_${index}`,
              date: schedule.date,
              time: schedule.time,
              activityName: schedule.activity,
              location: schedule.location,
              type: schedule.category === 'ììœ ì‹œê°„' ? 'free' : 'activity',
              adminNotes: schedule.notes || '',
              participants: schedule.participants || '',
              aiParsed: true
            }))
            
            console.log('AI íŒŒì‹±ëœ ì¼ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤:', schedulesData.length, 'ê°œ')
          }
        }

        // AI íŒŒì‹±ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ Firebase ìŠ¤ì¼€ì¤„ í™•ì¸
        if (schedulesData.length === 0) {
          const schedulesQuery = query(
            collection(db, 'schedules'),
            where('projectId', '==', projectId),
            orderBy('date', 'asc')
          )
          const schedulesSnapshot = await getDocs(schedulesQuery)
          schedulesData = schedulesSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }))
        }
        
        if (schedulesData.length > 0) {
          // ğŸ“‹ ììœ ì¼ì • ì¹´ë“œ ìë™ ì‚½ì… ë¡œì§
          const enhancedSchedules = []
          
          // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
          const schedulesByDate = {}
          schedulesData.forEach(schedule => {
            const date = schedule.date
            if (!schedulesByDate[date]) {
              schedulesByDate[date] = []
            }
            schedulesByDate[date].push(schedule)
          })

          // ê° ë‚ ì§œì˜ ë§ˆì§€ë§‰ì— ììœ ì¼ì • ì¹´ë“œ ì¶”ê°€
          Object.keys(schedulesByDate).sort().forEach(date => {
            const daySchedules = schedulesByDate[date]
            
            // í•´ë‹¹ ë‚ ì§œì˜ ì¼ì •ë“¤ì„ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
            daySchedules.sort((a, b) => {
              const timeA = a.time ? a.time.replace(':', '') : '0000'
              const timeB = b.time ? b.time.replace(':', '') : '0000'
              return timeA.localeCompare(timeB)
            })
            
            // ê¸°ì¡´ ì¼ì •ë“¤ ì¶”ê°€
            enhancedSchedules.push(...daySchedules)
            
            // í•´ë‹¹ ë‚ ì§œì— ììœ ì¼ì •ì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ì¶”ê°€
            const hasFreeSchedule = daySchedules.some(s => s.type === 'free')
            if (!hasFreeSchedule) {
              const freeScheduleCard = {
                id: `auto_free_${date}`,
                date: date,
                time: 'ììœ ì‹œê°„',
                activityName: 'ğŸ—“ï¸ ììœ ì¼ì •',
                location: 'ììœ  ì„ íƒ',
                type: 'free',
                adminNotes: 'ê°œì¸ ë˜ëŠ” íŒ€ë³„ë¡œ ììœ ë¡­ê²Œ ê³„íší•  ìˆ˜ ìˆëŠ” ì‹œê°„ì…ë‹ˆë‹¤. ìƒˆë¡œìš´ í™œë™ì„ ë§Œë“¤ê±°ë‚˜ ì°¸ì—¬í•´ë³´ì„¸ìš”!',
                autoGenerated: true
              }
              enhancedSchedules.push(freeScheduleCard)
            }
          })

          setSchedules(enhancedSchedules)
        } else {
          // Firebaseì—ì„œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš©
          console.log('Firebaseì— ì¼ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.')
          const testSchedules = generateTestSchedules()
          setSchedules(testSchedules)
        }
      } catch (firebaseError) {
        console.log('Firebase ì—°ê²° ì‹¤íŒ¨, í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš©:', firebaseError)
        // Firebase ì—°ê²° ì‹¤íŒ¨ ì‹œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš©
        const testSchedules = generateTestSchedules()
        setSchedules(testSchedules)
      }

      // í…ŒìŠ¤íŠ¸ ì¼ì • ìƒì„± í•¨ìˆ˜
      const generateTestSchedules = () => {
        const today = new Date()
        const tomorrow = new Date(today)
        tomorrow.setDate(today.getDate() + 1)
        const dayAfter = new Date(today)
        dayAfter.setDate(today.getDate() + 2)

        return [
          {
            id: 'test_schedule_1',
            date: today.toISOString().split('T')[0],
            time: '09:00',
            activityName: 'ğŸ›ï¸ ë¬¸í™”ìœ ì‚° íƒë°©',
            location: 'ê³ ê¶ ë°•ë¬¼ê´€',
            type: 'activity',
            adminNotes: 'í…ŒìŠ¤íŠ¸ ì¼ì •ì…ë‹ˆë‹¤. ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ê³„íšì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ ì‹¤ì œ ì¼ì •ìœ¼ë¡œ êµì²´ë©ë‹ˆë‹¤.'
          },
          {
            id: 'test_schedule_2',
            date: today.toISOString().split('T')[0],
            time: '14:00',
            activityName: 'ğŸ—“ï¸ ììœ ì‹œê°„ í™œë™',
            location: 'ê°œì¸ ì„ íƒ',
            type: 'free',
            adminNotes: 'ììœ ì¼ì • ê´€ë¦¬ í˜ì´ì§€ì—ì„œ ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”.',
            autoGenerated: true
          },
          {
            id: 'test_schedule_3',
            date: tomorrow.toISOString().split('T')[0],
            time: '10:00',
            activityName: 'ğŸ¢ í˜„ì§€ ê¸°ê´€ ë°©ë¬¸',
            location: 'êµìœ¡ì²­',
            type: 'activity',
            adminNotes: 'í…ŒìŠ¤íŠ¸ ì¼ì •ì…ë‹ˆë‹¤.'
          },
          {
            id: 'test_schedule_4',
            date: tomorrow.toISOString().split('T')[0],
            time: 'ììœ ì‹œê°„',
            activityName: 'ğŸ—“ï¸ ììœ ì¼ì •',
            location: 'ììœ  ì„ íƒ',
            type: 'free',
            adminNotes: 'ììœ ë¡­ê²Œ ì‹œê°„ì„ ë³´ë‚´ì„¸ìš”!',
            autoGenerated: true
          },
          {
            id: 'test_schedule_5',
            date: dayAfter.toISOString().split('T')[0],
            time: '19:00',
            activityName: 'ğŸŒƒ ì €ë… ë¬¸í™”ì²´í—˜',
            location: 'ì „í†µ ê³µì—°ì¥',
            type: 'afternoon',
            adminNotes: 'í…ŒìŠ¤íŠ¸ ì €ë… í™œë™ì…ë‹ˆë‹¤.'
          }
        ]
      }

      // ê³µì§€ì‚¬í•­ ë°ì´í„° ë¡œë“œ (ì‹¤ì‹œê°„ Firebase ì—°ë™)
      try {
        const announcementQuery = query(
          collection(db, 'announcements'),
          where('projectId', '==', projectId),
          orderBy('createdAt', 'desc')
        )
        const announcementSnapshot = await getDocs(announcementQuery)
        const announcementData = announcementSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }))

        if (announcementData.length > 0) {
          setAnnouncements(announcementData.slice(0, 3)) // ìµœì‹  3ê°œë§Œ
        } else {
          // ê³µì§€ì‚¬í•­ì´ ì—†ìœ¼ë©´ í…ŒìŠ¤íŠ¸ ê³µì§€ì‚¬í•­ í‘œì‹œ
          setAnnouncements([
            {
              id: 'test_notice_1',
              content: 'ğŸ“¢ í…ŒìŠ¤íŠ¸ ê³µì§€ì‚¬í•­ì…ë‹ˆë‹¤. ê´€ë¦¬ìê°€ ì‹¤ì œ ê³µì§€ì‚¬í•­ì„ ë“±ë¡í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.',
              author: 'ì‹œìŠ¤í…œ ê´€ë¦¬ì',
              date: new Date().toISOString(),
              urgentLevel: 'normal'
            },
            {
              id: 'test_notice_2',
              content: 'ğŸ’¡ PDF ê³„íšì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ì¼ì •ì´ íŒŒì‹±ë˜ì–´ í‘œì‹œë©ë‹ˆë‹¤.',
              author: 'ì‹œìŠ¤í…œ ê´€ë¦¬ì',
              date: new Date().toISOString(),
              urgentLevel: 'important'
            }
          ])
        }
      } catch (fbError) {
        console.log('Firebase ê³µì§€ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨:', fbError)
        // ì˜¤ë¥˜ ì‹œì—ë„ í…ŒìŠ¤íŠ¸ ê³µì§€ì‚¬í•­ í‘œì‹œ
        setAnnouncements([
          {
            id: 'test_notice_error',
            content: "ğŸ“¢ ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.",
            author: "ì‹œìŠ¤í…œ",
            date: new Date().toISOString(),
            urgentLevel: "normal"
          }
        ])
      }

      // ğŸ“Š ì‹¤ì‹œê°„ ì‚¬ìš©ì í†µê³„ ë¡œë“œ
      await loadUserStats(userData.id)

      // ğŸ† íŒ€ ìˆœìœ„ ë¡œë“œ
      await loadTeamRanking(userData.team)

      setLoading(false)
    } catch (error) {
      console.error('í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error)
      toast.error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
      setLoading(false)
    }
  }

  // ğŸ“Š ì‹¤ì‹œê°„ ì‚¬ìš©ì í†µê³„ ë¡œë“œ í•¨ìˆ˜
  const loadUserStats = async (userId) => {
    try {
      let commentsCount = 0
      let reactionsCount = 0  
      let photosCount = 0

      // Firebaseì—ì„œ ì‹¤ì œ ë°ì´í„° ë¡œë“œ ì‹œë„
      try {
        // ëŒ“ê¸€ ìˆ˜ ì¡°íšŒ
        const commentsQuery = query(
          collection(db, 'comments'),
          where('userId', '==', userId)
        )
        const commentsSnapshot = await getDocs(commentsQuery)
        commentsCount = commentsSnapshot.size

        // ë°˜ì‘ ìˆ˜ ì¡°íšŒ
        const reactionsQuery = query(
          collection(db, 'reactions'),
          where('userId', '==', userId)
        )
        const reactionsSnapshot = await getDocs(reactionsQuery)
        reactionsCount = reactionsSnapshot.size

        // ì¢‹ì•„ìš” ìˆ˜ ì¡°íšŒ
        const likesQuery = query(
          collection(db, 'likes'),
          where('userId', '==', userId)
        )
        const likesSnapshot = await getDocs(likesQuery)
        reactionsCount += likesSnapshot.size

        // ì‚¬ì§„ ìˆ˜ ì¡°íšŒ
        const photosQuery = query(
          collection(db, 'photos'),
          where('uploaderId', '==', userId)
        )
        const photosSnapshot = await getDocs(photosQuery)
        photosCount = photosSnapshot.size

        console.log('ğŸ“Š ì‹¤ì‹œê°„ í†µê³„:', { commentsCount, reactionsCount, photosCount })

      } catch (fbError) {
        console.log('Firebase í†µê³„ ë¡œë“œ ì‹¤íŒ¨, ì„ì‹œ ë°ì´í„° ì‚¬ìš©:', fbError)
        // Firebase ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ìœ ì§€
        commentsCount = 3
        reactionsCount = 12
        photosCount = 2
      }

      // í†µê³„ ì—…ë°ì´íŠ¸
      setUserStats({
        comments: commentsCount,
        reactions: reactionsCount,
        photos: photosCount
      })

    } catch (error) {
      console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error)
    }
  }

  // ğŸ† íŒ€ ìˆœìœ„ ë¡œë“œ í•¨ìˆ˜
  const loadTeamRanking = async (teamName) => {
    try {
      // ì‹¤ì œ íŒ€ë³„ ë°ì´í„°ë¥¼ ì‹œë®¬ë ˆì´ì…˜ (team-ranking.jsì™€ ë™ì¼í•œ ë¡œì§)
      const mockTeams = [
        {
          name: 'í”„ë¼í•˜ íƒí—˜ëŒ€',
          startDate: '2025-08-05T09:00:00Z',
          totalScore: 0,
          activities: { photos: 15, comments: 24, reactions: 45, participationRate: 98 }
        },
        {
          name: 'ë¹„ì—”ë‚˜ ì—¬í–‰ë‹¨',
          startDate: '2025-08-13T09:00:00Z',
          totalScore: 0,
          activities: { photos: 12, comments: 18, reactions: 32, participationRate: 85 }
        },
        {
          name: 'ì¤‘ë¶€ìœ ëŸ½ ëŸ¬ë²„ì¦ˆ',
          startDate: '2025-08-07T09:00:00Z',
          totalScore: 0,
          activities: { photos: 18, comments: 31, reactions: 52, participationRate: 92 }
        },
        {
          name: 'ì²´ì½”&ì˜¤ìŠ¤íŠ¸ë¦¬ì•„',
          startDate: '2025-08-10T09:00:00Z',
          totalScore: 0,
          activities: { photos: 10, comments: 15, reactions: 28, participationRate: 78 }
        }
      ]

      // ì ˆëŒ€ì  ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì ìˆ˜ ê³„ì‚°
      const now = new Date()
      const rankedTeams = mockTeams.map(team => {
        const startTime = new Date(team.startDate)
        const hoursFromStart = Math.max(0, (now - startTime) / (1000 * 60 * 60))
        const timeWeight = Math.min(hoursFromStart / 14, 2)
        
        const photoScore = team.activities.photos * 5
        const commentScore = team.activities.comments * 3
        const reactionScore = team.activities.reactions * 1
        const participationBonus = team.activities.participationRate * 2
        
        const baseScore = photoScore + commentScore + reactionScore + participationBonus
        const totalScore = Math.round(baseScore * timeWeight)
        
        return { ...team, totalScore }
      }).sort((a, b) => b.totalScore - a.totalScore)

      // í˜„ì¬ íŒ€ì˜ ìˆœìœ„ ì°¾ê¸°
      const myTeamIndex = rankedTeams.findIndex(team => team.name === teamName)
      const currentRank = myTeamIndex + 1
      const pointsToNext = myTeamIndex > 0 ? rankedTeams[myTeamIndex - 1].totalScore - rankedTeams[myTeamIndex].totalScore : 0

      // ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€ ìƒì„±
      const motivationMessages = [
        "ì„ ìƒë‹˜ë“¤ë³´ë‹¤ ë” ë§ì´ ì‘ì„±í•˜ì§€ ì•Šì„ê¹Œìš”? ğŸ“âœ¨",
        "ì´ì •ë„ ì°¸ì—¬ë„ë©´ ì„ ìƒë‹˜ë“¤ë„ ê¹œì§ ë†€ë¼ì‹¤ ê²ƒ ê°™ì•„ìš”! ğŸ‘¨â€ğŸ«ğŸ˜®",
        "ë²Œì¨ ì´ë ‡ê²Œ í™œë°œí•˜ì‹œë‹¤ë‹ˆ, ì—°ìˆ˜ê°€ ëë‚  ë•Œê¹Œì§€ ì–¼ë§ˆë‚˜ ë” ì„±ì¥í•˜ì‹¤ì§€ ê¸°ëŒ€ë¼ìš”! ğŸš€",
        "ì„ ìƒë‹˜ë“¤ ëˆˆì— ëŒ ë§Œí•œ í™œë™ëŸ‰ì´ë„¤ìš”! ê³„ì† ì´ëŸ° ì—´ì • ë³´ì—¬ì£¼ì„¸ìš”! ğŸ”¥",
        "ì´ëŸ° ì ê·¹ì„±ì´ë¼ë©´ ë‹¤ë¥¸ íŒ€ë“¤ë„ ìê·¹ë°›ì„ ê²ƒ ê°™ì•„ìš”! ğŸ’ª",
        "ì„ ìƒë‹˜ë“¤ì´ ë³´ì‹œë©´ 'ì´ íŒ€ì€ ì •ë§ íŠ¹ë³„í•˜ë‹¤'ê³  ìƒê°í•˜ì‹¤ ê±°ì˜ˆìš”! â­",
        "ì—°ìˆ˜ ê¸°ê°„ ë™ì•ˆ ê°€ì¥ í™œë°œí•œ íŒ€ì´ ë  ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ìš”! ğŸ†"
      ]

      setTeamRanking({
        currentRank,
        totalTeams: rankedTeams.length,
        pointsToNext,
        motivationMessage: motivationMessages[Math.floor(Math.random() * motivationMessages.length)]
      })

    } catch (error) {
      console.error('íŒ€ ìˆœìœ„ ë¡œë“œ ì˜¤ë¥˜:', error)
    }
  }

  const handleLogout = () => {
    localStorage.removeItem('userSession')
    toast.success('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.')
    router.push('/')
  }

  const formatDate = (dateString) => {
    const date = new Date(dateString)
    return date.toLocaleDateString('ko-KR', {
      month: 'long',
      day: 'numeric',
      weekday: 'short'
    })
  }

  const getMotivationMessage = () => {
    const { comments, reactions, photos } = userStats
    const total = comments + reactions + photos
    
    if (total === 0) {
      return "ì•„ì§ ì°¸ì—¬ê°€ ë¶€ì¡±í•´ìš” ğŸ˜¢ ì‚¬ì§„ì„ ì˜¬ë¦¬ê³  ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!"
    } else if (total < 5) {
      return "ì¢‹ì€ ì‹œì‘ì´ì—ìš”! ğŸ‘ ë” ë§ì´ ì°¸ì—¬í•´ë³´ì„¸ìš”!"
    } else if (total < 15) {
      return "í™œë°œí•˜ê²Œ ì°¸ì—¬í•˜ê³  ê³„ì‹œë„¤ìš”! ğŸ‰"
    } else {
      return "ì •ë§ ë©‹ì§„ ì°¸ì—¬ë„ì…ë‹ˆë‹¤! ğŸŒŸ ìµœê³ ì—ìš”!"
    }
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="text-lg">ë°ì´í„° ë¡œë”© ì¤‘...</div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-100">
      {/* í—¤ë” */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-4">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">
                {project?.projectName}
              </h1>
              <p className="text-sm text-gray-600">
                {user?.name}ë‹˜ ({user?.affiliation})
              </p>
            </div>
            <button
              onClick={handleLogout}
              className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors text-sm"
            >
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div className="px-4 py-6 sm:px-0">
          
          {/* ìƒë‹¨: ê³µì§€ì‚¬í•­ + ì˜¤ëŠ˜ì˜ í™œë™ */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            
            {/* ğŸ“¢ ê³µì§€ì‚¬í•­ */}
            <div className="bg-white rounded-lg shadow-md">
              <div className="p-4 border-b bg-yellow-50">
                <h2 className="text-lg font-semibold text-yellow-800 flex items-center">
                  ğŸ“¢ ìµœì‹  ê³µì§€ì‚¬í•­
                </h2>
              </div>
              <div className="p-4">
                {announcements.length > 0 ? (
                  <div className="space-y-3">
                    {announcements.slice(0, 2).map(announcement => (
                      <div key={announcement.id} className={`p-3 rounded-lg ${
                        announcement.urgentLevel === 'urgent' ? 'bg-red-50 border border-red-200' :
                        announcement.urgentLevel === 'important' ? 'bg-orange-50 border border-orange-200' :
                        'bg-blue-50 border border-blue-200'
                      }`}>
                        <div className="flex items-start justify-between mb-1">
                          <span className={`text-xs px-2 py-1 rounded-full ${
                            announcement.urgentLevel === 'urgent' ? 'bg-red-100 text-red-800' :
                            announcement.urgentLevel === 'important' ? 'bg-orange-100 text-orange-800' :
                            'bg-blue-100 text-blue-800'
                          }`}>
                            {announcement.urgentLevel === 'urgent' ? 'ğŸš¨ ê¸´ê¸‰' :
                             announcement.urgentLevel === 'important' ? 'âš ï¸ ì¤‘ìš”' : 'ğŸ“¢ ì¼ë°˜'}
                          </span>
                          <span className="text-xs text-gray-500">
                            {formatDate(announcement.date)}
                          </span>
                        </div>
                        <p className="text-sm text-gray-800">{announcement.content}</p>
                        <p className="text-xs text-gray-600 mt-1">- {announcement.author}</p>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <div className="text-3xl mb-2">ğŸ“­</div>
                    <p className="text-gray-600">ìƒˆë¡œìš´ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤</p>
                  </div>
                )}
              </div>
            </div>

            {/* ğŸ“… ì˜¤ëŠ˜ì˜ í™œë™ */}
            <div className="bg-white rounded-lg shadow-md">
              <div className="p-4 border-b bg-blue-50">
                <h2 className="text-lg font-semibold text-blue-800 flex items-center">
                  ğŸ“… ì˜¤ëŠ˜ì˜ í™œë™
                </h2>
              </div>
              <div className="p-4">
                {(() => {
                  const today = new Date().toISOString().split('T')[0]
                  const todaySchedules = schedules.filter(schedule => schedule.date === today)
                  
                  return todaySchedules.length > 0 ? (
                    <div className="space-y-3">
                      {todaySchedules.map((schedule) => (
                        <div 
                          key={schedule.id}
                          onClick={() => router.push(`/activity/${schedule.id}`)}
                          className="p-3 border border-gray-200 rounded-lg hover:shadow-md transition-shadow cursor-pointer"
                        >
                          <div className="flex items-center justify-between mb-2">
                            <div className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">
                              {schedule.time}
                            </div>
                            <span className="text-xs text-gray-500">ğŸ“ {schedule.location}</span>
                          </div>
                          <h3 className="font-semibold text-gray-900">{schedule.activityName}</h3>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-8">
                      <div className="text-3xl mb-2">ğŸ—“ï¸</div>
                      <p className="text-gray-600">ì˜¤ëŠ˜ ì˜ˆì •ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                  )
                })()}
              </div>
            </div>
          </div>
          
          {/* ğŸ—ºï¸ ë¹ ë¥¸ ë§í¬ */}
          <div className="mb-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Link href="/free-schedule">
                <div className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer border-2 border-transparent hover:border-green-300">
                  <div className="text-center">
                    <div className="text-4xl mb-3">ğŸ—“ï¸</div>
                    <h3 className="text-lg font-semibold text-gray-900 mb-2">ììœ ì¼ì • ê´€ë¦¬</h3>
                    <p className="text-gray-600 text-sm">ììœ ì‹œê°„ í™œë™ ê³„íší•˜ê¸°</p>
                  </div>
                </div>
              </Link>
              
              <Link href="/team-ranking">
                <div className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer border-2 border-transparent hover:border-purple-300">
                  <div className="text-center">
                    <div className="text-4xl mb-3">ğŸ“Š</div>
                    <h3 className="text-lg font-semibold text-gray-900 mb-2">íŒ€ë³„ ìˆœìœ„</h3>
                    <p className="text-gray-600 text-sm">ì‹¤ì‹œê°„ ì°¸ì—¬ë„ ë­í‚¹</p>
                    
                    {/* í˜„ì¬ íŒ€ ìˆœìœ„ í‘œì‹œ */}
                    <div className="mt-3 p-3 bg-purple-50 rounded-lg">
                      <div className="text-lg font-bold text-purple-800">
                        í˜„ì¬ {teamRanking.currentRank}ìœ„ / {teamRanking.totalTeams}íŒ€
                      </div>
                      {teamRanking.pointsToNext > 0 && (
                        <div className="text-sm text-purple-600 mt-1">
                          ìƒìœ„íŒ€ê³¼ {teamRanking.pointsToNext}ì  ì°¨ì´
                        </div>
                      )}
                      {teamRanking.currentRank === 1 && (
                        <div className="text-sm text-purple-600 mt-1">
                          ğŸ† í˜„ì¬ 1ìœ„! 
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </Link>
            </div>
          </div>

          {/* ì°¸ì—¬ í˜„í™© ì¹´ë“œ - ìƒˆë¡œìš´ ìœ„ì¹˜ */}
          <div className="mb-6">
            <div className="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-lg p-6 text-white shadow-lg">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-semibold flex items-center">
                  ğŸŒŸ {user?.name}ë‹˜ì˜ ì°¸ì—¬ í˜„í™©
                </h2>
                <button
                  onClick={() => {
                    loadUserStats(user?.id)
                    loadTeamRanking(user?.team)
                  }}
                  className="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded-full text-sm transition-all"
                >
                  ğŸ”„ ìƒˆë¡œê³ ì¹¨
                </button>
              </div>
              <div className="grid grid-cols-3 gap-4 mb-4">
                <div className="text-center bg-white bg-opacity-10 rounded-lg p-3">
                  <div className="text-3xl font-bold">{userStats.photos}</div>
                  <div className="text-sm opacity-90">ï¿½ ì‚¬ì§„</div>
                </div>
                <div className="text-center bg-white bg-opacity-10 rounded-lg p-3">
                  <div className="text-3xl font-bold">{userStats.comments}</div>
                  <div className="text-sm opacity-90">ğŸ’¬ ëŒ“ê¸€</div>
                </div>
                <div className="text-center bg-white bg-opacity-10 rounded-lg p-3">
                  <div className="text-3xl font-bold">{userStats.reactions}</div>
                  <div className="text-sm opacity-90">ï¿½ ë°˜ì‘</div>
                </div>
              </div>
              <div className="text-center">
                <p className="text-lg opacity-95 font-medium">{getMotivationMessage()}</p>
                {teamRanking.motivationMessage && (
                  <p className="text-sm opacity-90 mt-2 bg-white bg-opacity-20 rounded-lg p-2">
                    ğŸ’¡ {teamRanking.motivationMessage}
                  </p>
                )}
              </div>
            </div>
          </div>

          {/* ì—°ìˆ˜ ì¼ì • */}
          <div className="mb-8">
            <h2 className="text-2xl font-bold text-gray-900 mb-4">
              ğŸ“… ì—°ìˆ˜ ì¼ì •
            </h2>
            <div className="grid gap-4">
              {schedules.map((schedule) => (
                <div
                  key={schedule.id}
                  className="bg-white rounded-lg shadow-md border border-gray-200 p-6 hover:shadow-lg transition-shadow cursor-pointer"
                  onClick={() => {
                    if (schedule.type === 'afternoon') {
                      router.push(`/afternoon/${schedule.id}`)
                    } else if (schedule.type === 'free') {
                      router.push(`/free-schedule`)
                    } else {
                      router.push(`/activity/${schedule.id}`)
                    }
                  }}
                >
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <div className="flex items-center space-x-3 mb-2">
                        <div className={`px-3 py-1 rounded-full text-sm font-medium ${
                          schedule.type === 'afternoon' 
                            ? 'bg-orange-100 text-orange-800' 
                            : schedule.type === 'free'
                            ? 'bg-purple-100 text-purple-800'
                            : 'bg-blue-100 text-blue-800'
                        }`}>
                          {formatDate(schedule.date)}
                        </div>
                        <div className="text-gray-600 text-sm">
                          {schedule.time}
                        </div>
                        {schedule.type === 'afternoon' && (
                          <span className="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs">
                            ğŸŒ… ì˜¤í›„í™œë™
                          </span>
                        )}
                        {schedule.type === 'free' && (
                          <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">
                            ğŸ—“ï¸ ììœ ì¼ì •
                          </span>
                        )}
                      </div>
                      <h3 className="text-xl font-semibold text-gray-900 mb-2">
                        {schedule.activityName}
                      </h3>
                      <p className="text-gray-600 flex items-center">
                        ğŸ“ {schedule.location}
                      </p>
                      {schedule.adminNotes && (
                        <p className="text-sm text-blue-600 mt-2">
                          ğŸ’¡ {schedule.adminNotes}
                        </p>
                      )}
                    </div>
                    <div className="flex flex-col items-end space-y-2">
                      <div className={`px-3 py-1 rounded-full text-sm ${
                        schedule.type === 'afternoon'
                          ? 'bg-orange-100 text-orange-600'
                          : schedule.type === 'free'
                          ? 'bg-purple-100 text-purple-600'
                          : 'bg-gray-100 text-gray-600'
                      }`}>
                        {schedule.type === 'afternoon' ? 'ğŸ¨ ìˆ™ì†Œí™œë™' : 
                         schedule.type === 'free' ? 'ğŸ—“ï¸ ììœ ì¼ì •' : 'ğŸ“¸ ì‚¬ì§„ ê°¤ëŸ¬ë¦¬'}
                      </div>
                      <div className="text-sm text-gray-500">
                        í´ë¦­í•˜ì—¬ ë³´ê¸° â†’
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ë“¤ */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button className="bg-white rounded-lg shadow-md border border-gray-200 p-4 hover:shadow-lg transition-shadow">
              <div className="text-2xl mb-2">ğŸ“¸</div>
              <div className="font-medium text-gray-900">ì‚¬ì§„ ì—…ë¡œë“œ</div>
              <div className="text-sm text-gray-600">ìƒˆ ì‚¬ì§„ ì¶”ê°€</div>
            </button>
            
            <button className="bg-white rounded-lg shadow-md border border-gray-200 p-4 hover:shadow-lg transition-shadow">
              <div className="text-2xl mb-2">ğŸ—ºï¸</div>
              <div className="font-medium text-gray-900">ì „ì²´ ë™ì„ </div>
              <div className="text-sm text-gray-600">ì—°ìˆ˜ ê²½ë¡œ ë³´ê¸°</div>
            </button>
            
            <button className="bg-white rounded-lg shadow-md border border-gray-200 p-4 hover:shadow-lg transition-shadow">
              <div className="text-2xl mb-2">ğŸ½ï¸</div>
              <div className="font-medium text-gray-900">ì¶”ì²œ ì¥ì†Œ</div>
              <div className="text-sm text-gray-600">ë§›ì§‘ & ëª…ì†Œ</div>
            </button>
            
            <button className="bg-white rounded-lg shadow-md border border-gray-200 p-4 hover:shadow-lg transition-shadow">
              <div className="text-2xl mb-2">ğŸ‘¥</div>
              <div className="font-medium text-gray-900">íŒ€ ì •ë³´</div>
              <div className="text-sm text-gray-600">{user?.team} ë©¤ë²„</div>
            </button>
          </div>

        </div>
      </main>
    </div>
  )
}

// ğŸ“… ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
const formatDate = (dateString) => {
  const date = new Date(dateString)
  const month = date.getMonth() + 1
  const day = date.getDate()
  const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ']
  const dayName = dayNames[date.getDay()]
  
  return `${month}/${day} (${dayName})`
}


