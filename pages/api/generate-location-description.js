import { db } from '../../firebaseConfig';
import { collection, addDoc, getDocs, query, where, updateDoc, doc } from 'firebase/firestore';

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ success: false, error: 'Method not allowed' });
  }

  try {
    const { location, activity, scheduleId, userRegion } = req.body;

    if (!location || !activity || !scheduleId) {
      return res.status(400).json({ success: false, error: '필수 정보가 누락되었습니다.' });
    }

    // 기존에 생성된 소개가 있는지 확인
    const existingQuery = query(
      collection(db, 'location-descriptions'),
      where('scheduleId', '==', scheduleId),
      where('location', '==', location)
    );
    
    const existingDocs = await getDocs(existingQuery);
    
    if (!existingDocs.empty) {
      // 기존 소개가 있으면 그대로 반환
      const existingData = existingDocs.docs[0].data();
      return res.status(200).json({
        success: true,
        description: existingData.description,
        title: existingData.title,
        highlights: existingData.highlights,
        tips: existingData.tips,
        message: '기존에 생성된 장소 소개를 불러왔습니다.'
      });
    }

    // AI로 장소 소개 생성 (실제로는 OpenAI API 호출)
    const locationInfo = await generateLocationDescription(location, activity, userRegion);

    // DB에 소개 저장
    const descriptionData = {
      scheduleId: scheduleId,
      location: location,
      activity: activity,
      userRegion: userRegion,
      title: locationInfo.title,
      description: locationInfo.description,
      highlights: locationInfo.highlights,
      tips: locationInfo.tips,
      createdAt: new Date(),
      aiVersion: '2.0'
    };

    await addDoc(collection(db, 'location-descriptions'), descriptionData);

    res.status(200).json({
      success: true,
      title: locationInfo.title,
      description: locationInfo.description,
      highlights: locationInfo.highlights,
      tips: locationInfo.tips,
      message: 'AI가 생성한 장소 소개를 저장했습니다.'
    });

  } catch (error) {
    console.error('장소 소개 생성 오류:', error);
    res.status(500).json({ 
      success: false, 
      error: '장소 소개 생성 중 오류가 발생했습니다.' 
    });
  }
}

// AI로 장소 소개 생성 (시뮬레이션)
async function generateLocationDescription(location, activity, userRegion) {
  // 실제로는 OpenAI API를 호출하지만, 여기서는 시뮬레이션
  const locationLower = location.toLowerCase();
  
  // 장소별 맞춤 소개 생성
  let title = location;
  let description = '';
  let highlights = [];
  let tips = [];

  if (locationLower.includes('프라하 성') || locationLower.includes('prazsky hrad')) {
    title = '프라하 성 (Pražský hrad)';
    description = `프라하 성은 체코의 상징적인 성채로, 9세기부터 현재까지 이어져온 세계에서 가장 큰 고대 성채 중 하나입니다. 체코 공화국의 대통령 관저이자 국가의 상징적인 건축물로, 매년 수많은 관광객들이 방문하는 프라하의 대표적인 관광지입니다.

성 내부에는 성 세인트 비투스 대성당, 성 조지 대성당, 골든 레인, 로얄 팰리스 등 다양한 역사적 건물들이 자리잡고 있어, 방문자들에게 풍부한 문화적 경험을 제공합니다. 특히 성 세인트 비투스 대성당의 고딕 건축 양식과 스테인드글라스는 세계적으로 유명하며, 체코의 종교적, 문화적 정체성을 잘 보여줍니다.`;
    
    highlights = [
      '🏛️ 성 세인트 비투스 대성당 - 고딕 건축의 걸작',
      '👑 로얄 팰리스 - 체코 왕들의 거주지',
      '🛤️ 골든 레인 - 중세 시대의 작은 집들',
      '🌹 성 조지 대성당 - 로마네스크 건축물',
      '🏰 성 정원 - 아름다운 전경과 휴식 공간'
    ];
    
    tips = [
      '오전 9시 이전에 방문하면 관광객이 적어 편안하게 관람할 수 있습니다',
      '성내 구역은 무료이지만 개별 건물은 유료입니다 (통합 티켓 권장)',
      '정오에 성에서 시내로 향하는 교대식을 볼 수 있습니다',
      '가이드 투어를 예약하면 더 자세한 역사적 설명을 들을 수 있습니다',
      '성의 정원에서 프라하 시내의 아름다운 전경을 사진으로 담아보세요'
    ];
  } else if (locationLower.includes('카를교') || locationLower.includes('charles bridge')) {
    title = '카를교 (Karlův most)';
    description = `카를교는 프라하의 상징적인 중세 다리로, 1357년 카를 4세의 명령으로 건설되어 600년 이상의 역사를 자랑합니다. 프라하 성과 올드타운을 연결하는 이 다리는 체코의 건축 기술과 예술적 성취를 보여주는 대표적인 건축물입니다.

다리 위에는 30개의 성인상들이 세워져 있어, 방문자들에게 종교적, 역사적 의미를 전달합니다. 특히 성 요한 네포무크 상은 가장 유명한 성상 중 하나로, 소원을 빌면 이루어진다는 전설이 전해져 많은 관광객들이 소원을 빌기 위해 방문합니다.`;
    
    highlights = [
      '🗿 30개의 성인상 - 중세 예술의 걸작',
      '⛪ 성 요한 네포무크 상 - 소원 성취의 전설',
      '🌅 일몰 전경 - 프라하의 아름다운 풍경',
      '🎨 거리 예술가들 - 생동감 넘치는 문화 공간',
      '📸 사진 명소 - 로맨틱한 분위기의 다리'
    ];
    
    tips = [
      '일몰과 일출 시간에 방문하면 가장 아름다운 전경을 볼 수 있습니다',
      '성 요한 네포무크 상에 소원을 빌 때는 오른손으로 성상을 만지세요',
      '다리 위의 거리 예술가들과 사진을 찍을 때는 팁을 준비하세요',
      '관광객이 많은 시간대에는 조용한 아침이나 저녁 시간을 추천합니다',
      '다리 양쪽의 탑에 올라가면 더욱 멋진 전경을 볼 수 있습니다'
    ];
  } else if (locationLower.includes('프라하 제1고등학교') || locationLower.includes('gymnazium')) {
    title = '프라하 제1고등학교 (Gymnázium Jana Nerudy)';
    description = `프라하 제1고등학교는 체코의 명문 고등학교로, 1865년 설립되어 150년 이상의 전통을 자랑하는 교육 기관입니다. 체코의 대표적인 시인 얀 네루다의 이름을 딴 이 학교는 우수한 교육 환경과 높은 학업 성취도로 유명합니다.

학교는 프라하의 역사적 중심지인 말라 스트라나 지역에 위치하여, 학생들이 풍부한 문화적 환경에서 학습할 수 있는 최적의 조건을 제공합니다. 학교 건물 자체도 역사적 가치가 높은 건축물로, 학생들에게 역사와 문화에 대한 이해를 돕는 교육적 환경을 제공합니다.`;
    
    highlights = [
      '📚 전통 있는 교육 기관 - 150년 이상의 역사',
      '🏛️ 역사적 건축물 - 문화재로 지정된 학교 건물',
      '🌍 국제 교류 프로그램 - 글로벌 시각 기르기',
      '🎓 우수한 교육 환경 - 높은 학업 성취도',
      '📍 말라 스트라나 지역 - 문화적 중심지 위치'
    ];
    
    tips = [
      '방문 전에 학교 측에 사전 예약을 하는 것이 좋습니다',
      '교육 정책과 교류 프로그램에 대한 자료를 미리 준비하세요',
      '통역 서비스가 필요할 수 있으니 미리 확인하세요',
      '학교 내부 촬영은 허가를 받아야 할 수 있습니다',
      '학생들과의 교류 시간을 미리 계획해보세요'
    ];
  } else if (locationLower.includes('국립박물관') || locationLower.includes('national museum')) {
    title = '프라하 국립박물관 (Národní muzeum)';
    description = `프라하 국립박물관은 체코에서 가장 큰 박물관으로, 1818년 설립되어 200년 이상의 역사를 자랑합니다. 체코의 자연사, 역사, 문화를 종합적으로 보여주는 이 박물관은 방문자들에게 체코의 풍부한 문화유산을 체계적으로 소개합니다.

박물관은 네오르네상스 양식의 웅장한 건물에 위치하여, 건축물 자체만으로도 관람 가치가 높습니다. 내부에는 고고학, 민족학, 자연사, 역사 등 다양한 분야의 전시물들이 체계적으로 배치되어 있어, 체코의 과거와 현재를 한눈에 볼 수 있습니다.`;
    
    highlights = [
      '🏛️ 네오르네상스 건축 - 웅장한 박물관 건물',
      '🦕 자연사 전시 - 공룡 화석과 자연 표본',
      '🏺 고고학 전시 - 체코의 고대 문화',
      '👥 민족학 전시 - 체코 민족의 문화',
      '📚 역사 전시 - 체코의 역사적 발전'
    ];
    
    tips = [
      '박물관은 월요일을 제외하고 매일 오전 10시부터 오후 6시까지 운영됩니다',
      '입장료는 성인 200크로나, 학생 130크로나입니다',
      '가이드 투어를 예약하면 더 자세한 설명을 들을 수 있습니다',
      '사진 촬영은 허용되지만 플래시 사용은 금지됩니다',
      '박물관 내 카페에서 휴식을 취할 수 있습니다'
    ];
  } else if (locationLower.includes('올드타운') || locationLower.includes('old town')) {
    title = '프라하 올드타운 (Staré Město)';
    description = `프라하 올드타운은 중세 시대부터 이어져온 프라하의 역사적 중심지로, 13세기부터 형성되기 시작한 이 지역은 체코의 문화와 역사를 가장 잘 보여주는 곳입니다. 아름다운 고딕 건축물들과 중세 시대의 거리 구조가 그대로 보존되어 있어, 방문자들에게 마치 시간을 거슬러 올라간 듯한 경험을 제공합니다.

올드타운 광장은 이 지역의 중심으로, 천문시계, 틴 성당, 성 니콜라스 성당 등 유명한 건축물들이 둘러싸고 있습니다. 특히 올드타운 시청의 천문시계는 매시 정각에 움직이는 인형들의 쇼로 유명하며, 세계에서 가장 오래된 천문시계 중 하나로 알려져 있습니다.`;
    
    highlights = [
      '🕰️ 천문시계 - 세계에서 가장 오래된 천문시계',
      '⛪ 틴 성당 - 고딕 건축의 대표작',
      '🏛️ 올드타운 시청 - 중세 시대의 행정 건물',
      '🎭 성 니콜라스 성당 - 바로크 건축의 걸작',
      '🛍️ 중세 거리 - 전통 상점과 카페들'
    ];
    
    tips = [
      '천문시계 쇼는 매시 정각에 시작되므로 미리 자리를 잡으세요',
      '올드타운 시청 탑에 올라가면 광장의 아름다운 전경을 볼 수 있습니다',
      '저녁 시간에 방문하면 조명이 켜진 건물들의 아름다운 모습을 볼 수 있습니다',
      '전통 체코 요리를 맛볼 수 있는 레스토랑들이 많이 있습니다',
      '가이드 투어를 통해 숨겨진 역사적 이야기들을 들을 수 있습니다'
    ];
  } else if (locationLower.includes('말라 스트라나') || locationLower.includes('mala strana')) {
    title = '말라 스트라나 (Malá Strana)';
    description = `말라 스트라나는 프라하의 아름다운 지역으로, '작은 지구'라는 의미를 가진 이 지역은 중세 시대부터 귀족들과 예술가들이 선호하던 곳입니다. 프라하 성 아래에 위치한 이 지역은 바로크 건축물들과 아름다운 정원들로 유명하며, 로맨틱한 분위기를 자랑합니다.

이 지역에는 성 니콜라스 성당, 발렌슈타인 궁전, 페트린 탑 등 유명한 관광지들이 밀집되어 있습니다. 특히 말라 스트라나의 거리들은 중세 시대의 분위기를 그대로 간직하고 있어, 방문자들에게 독특한 문화적 경험을 제공합니다.`;
    
    highlights = [
      '⛪ 성 니콜라스 성당 - 바로크 건축의 대표작',
      '🏰 발렌슗타인 궁전 - 웅장한 바로크 궁전',
      '🗼 페트린 탑 - 프라하의 작은 에펠탑',
      '🌹 발렌슗타인 정원 - 아름다운 바로크 정원',
      '🛤️ 네루다 거리 - 중세 시대의 분위기'
    ];
    
    tips = [
      '페트린 탑에 올라가면 프라하 전체의 아름다운 전경을 볼 수 있습니다',
      '발렌슗타인 정원은 봄과 여름에 가장 아름답습니다',
      '말라 스트라나의 레스토랑들은 전통 체코 요리를 맛볼 수 있는 곳들입니다',
      '저녁 시간에 방문하면 조명이 켜진 건물들의 아름다운 모습을 볼 수 있습니다',
      '가이드 투어를 통해 이 지역의 역사적 이야기들을 들을 수 있습니다'
    ];
  } else if (locationLower.includes('유대인 묘지') || locationLower.includes('jewish cemetery')) {
    title = '프라하 유대인 묘지 (Starý židovský hřbitov)';
    description = `프라하 유대인 묘지는 유럽에서 가장 오래된 유대인 묘지 중 하나로, 15세기부터 1787년까지 사용된 역사적 장소입니다. 약 12,000개의 묘비가 있는 이 묘지는 유대인 공동체의 역사와 문화를 보여주는 중요한 문화유산입니다.

묘지의 묘비들은 서로 겹쳐져 있는 독특한 형태로, 공간의 제약으로 인해 여러 층으로 쌓여 있습니다. 각 묘비에는 히브리어로 된 비문과 상징적인 조각들이 새겨져 있어, 유대인 문화와 종교적 전통을 이해할 수 있는 소중한 자료를 제공합니다.`;
    
    highlights = [
      '🪦 12,000개의 묘비 - 유럽 최고의 유대인 묘지',
      '📜 히브리어 비문 - 유대인 문화의 기록',
      '🏛️ 고대 묘지 - 15세기부터의 역사',
      '🎨 상징적 조각 - 종교적 의미의 표현',
      '🌳 평화로운 분위기 - 명상과 성찰의 공간'
    ];
    
    tips = [
      '묘지는 종교적 장소이므로 조용하고 경건한 마음으로 방문하세요',
      '사진 촬영은 허용되지만 플래시 사용은 금지됩니다',
      '유대인 박물관과 함께 방문하면 더 깊은 이해를 할 수 있습니다',
      '가이드 투어를 통해 각 묘비의 의미와 역사를 들을 수 있습니다',
      '방문 전에 유대인 문화에 대한 기본 지식을 갖추면 좋습니다'
    ];
  } else if (locationLower.includes('체스키 크롬로프') || locationLower.includes('cesky krumlov')) {
    title = '체스키 크롬로프 (Český Krumlov)';
    description = `체스키 크롬로프는 체코 남부에 위치한 아름다운 중세 도시로, 유네스코 세계문화유산으로 지정된 보물 같은 곳입니다. 블타바 강이 도시를 감싸고 있는 이 도시는 13세기부터 이어져온 역사적 건축물들과 아름다운 자연 경관을 자랑합니다.

도시의 중심에는 체스키 크롬로프 성이 우뚝 서 있어, 방문자들에게 웅장한 중세 시대의 분위기를 선사합니다. 성 내부의 바로크 극장은 세계에서 가장 잘 보존된 바로크 극장 중 하나로, 17세기부터 이어져온 무대 장치와 의상들이 그대로 보존되어 있습니다.`;
    
    highlights = [
      '🏰 체스키 크롬로프 성 - 중세 시대의 웅장한 성채',
      '🎭 바로크 극장 - 세계에서 가장 잘 보존된 바로크 극장',
      '🌊 블타바 강 - 도시를 감싸는 아름다운 강',
      '🏛️ 성 베드로와 바오로 성당 - 고딕 건축물',
      '🛤️ 중세 거리 - 역사적 분위기의 도시'
    ];
    
    tips = [
      '성의 바로크 극장은 사전 예약이 필요합니다',
      '블타바 강에서 래프팅을 즐길 수 있습니다',
      '도시는 하루 만에 충분히 둘러볼 수 있습니다',
      '저녁 시간에 방문하면 조명이 켜진 성의 아름다운 모습을 볼 수 있습니다',
      '전통 체코 요리와 와인을 맛볼 수 있는 레스토랑들이 많이 있습니다'
    ];
  } else if (locationLower.includes('카를로비 바리') || locationLower.includes('karlovy vary')) {
    title = '카를로비 바리 (Karlovy Vary)';
    description = `카를로비 바리는 체코에서 가장 유명한 온천 도시로, 14세기 카를 4세에 의해 발견된 이 도시는 유럽의 대표적인 온천 휴양지입니다. 13개의 온천수가 있는 이 도시는 건강과 휴식을 위한 최적의 장소로 알려져 있습니다.

도시는 테플라 강을 따라 아름다운 건축물들이 늘어서 있어, 방문자들에게 우아하고 고급스러운 분위기를 선사합니다. 특히 온천 건물들과 호텔들은 아르누보와 네오바로크 양식으로 지어져 있어, 건축적 가치도 높습니다.`;
    
    highlights = [
      '♨️ 13개의 온천수 - 건강에 좋은 미네랄 워터',
      '🏛️ 온천 건물들 - 아르누보 건축의 걸작',
      '🌊 테플라 강 - 도시를 가로지르는 아름다운 강',
      '🏨 고급 호텔들 - 럭셔리한 휴양 시설',
      '🎬 국제 영화제 - 세계적으로 유명한 영화제'
    ];
    
    tips = [
      '온천수를 마실 때는 특별한 컵을 사용합니다',
      '온천 목욕은 사전 예약이 필요할 수 있습니다',
      '도시의 온천 건물들을 둘러보는 투어가 있습니다',
      '카를로비 바리 와인을 맛볼 수 있는 와이너리들이 있습니다',
      '겨울에도 온천 시설을 이용할 수 있습니다'
    ];
  } else if (locationLower.includes('쿠트나 호라') || locationLower.includes('kutna hora')) {
    title = '쿠트나 호라 (Kutná Hora)';
    description = `쿠트나 호라는 중세 시대에 은광으로 번영했던 도시로, 현재는 유네스코 세계문화유산으로 지정된 역사적 도시입니다. 13세기부터 16세기까지 체코의 경제 중심지였던 이 도시는 성 바르바라 성당과 인골당으로 유명합니다.

성 바르바라 성당은 고딕 건축의 걸작으로, 1388년에 건설을 시작하여 1905년에 완성된 웅장한 성당입니다. 성당의 내부는 아름다운 스테인드글라스와 조각상들로 장식되어 있어, 방문자들에게 깊은 감동을 선사합니다.`;
    
    highlights = [
      '⛪ 성 바르바라 성당 - 고딕 건축의 걸작',
      '💀 인골당 - 독특한 인골 예술',
      '🏛️ 이탈리아 궁정 - 중세 시대의 행정 건물',
      '🛤️ 중세 거리 - 역사적 분위기의 도시',
      '🏰 성당 성당 - 도시의 상징적 건물'
    ];
    
    tips = [
      '성 바르바라 성당은 월요일을 제외하고 매일 개방됩니다',
      '인골당은 사전 예약이 필요할 수 있습니다',
      '도시는 프라하에서 기차로 1시간 거리에 있습니다',
      '가이드 투어를 통해 도시의 역사를 자세히 들을 수 있습니다',
      '전통 체코 요리를 맛볼 수 있는 레스토랑들이 있습니다'
    ];
  } else {
    // 일반적인 장소에 대한 소개 - 더 구체적이고 다양하게 생성
    const randomDescriptions = [
      {
        title: `${location} - 교육과 문화의 중심지`,
        description: `${location}은(는) 교육적 가치가 높고 문화적 의미가 깊은 장소로, 연수 참가자들에게 풍부한 학습 경험을 제공합니다. 이 장소는 역사적 배경과 현대적 교육 시설을 조화롭게 갖추고 있어, 이론과 실습을 균형있게 배울 수 있는 최적의 환경을 제공합니다.

특히 이곳의 전문적인 교육진과 체계적인 교육 프로그램은 참가자들의 전문성 향상과 글로벌 시각 확립에 크게 기여합니다. 현지의 교육 시스템과 문화를 직접 체험할 수 있는 소중한 기회를 통해, 참가자들은 새로운 관점과 인사이트를 얻을 수 있습니다.`,
        highlights: [
          '🎓 우수한 교육 환경 - 전문적인 교육 시설',
          '🌍 문화적 체험 - 현지 문화와 전통',
          '🏛️ 역사적 배경 - 풍부한 역사적 맥락',
          '👥 전문 교육진 - 경험 있는 교육자들',
          '📚 체계적 프로그램 - 균형잡힌 교육 과정'
        ],
        tips: [
          '방문 전에 운영시간과 예약 필요 여부를 확인하세요',
          '교육 자료나 질문사항을 미리 준비하면 좋습니다',
          '현지 가이드나 통역 서비스가 필요할 수 있습니다',
          '사진 촬영이 허용되는지 미리 확인하세요',
          '방문 후 느낀 점을 기록해두면 좋습니다'
        ]
      },
      {
        title: `${location} - 혁신과 전통의 만남`,
        description: `${location}은(는) 전통과 현대가 조화롭게 공존하는 독특한 장소로, 연수 참가자들에게 새로운 시각과 경험을 제공합니다. 이곳의 혁신적인 접근 방식과 전통적 가치관의 조화는 교육 현장에 적용할 수 있는 귀중한 인사이트를 제공합니다.

장소의 특별한 교육 철학과 운영 방식은 참가자들에게 새로운 교육 패러다임을 제시하며, 글로벌 교육 트렌드와 현지 특성을 결합한 독창적인 교육 모델을 보여줍니다. 이러한 경험은 참가자들의 교육적 시각을 넓히고 실무에 적용할 수 있는 구체적인 아이디어를 제공합니다.`,
        highlights: [
          '🔄 혁신적 접근 - 새로운 교육 방식',
          '🏛️ 전통적 가치 - 역사적 교육 철학',
          '🌍 글로벌 시각 - 국제적 교육 트렌드',
          '💡 창의적 모델 - 독창적인 교육 시스템',
          '📊 실무 적용 - 구체적인 교육 방법'
        ],
        tips: [
          '교육 철학과 운영 방식에 대한 자료를 미리 준비하세요',
          '현지 교육자들과의 교류 시간을 계획해보세요',
          '교육 시설과 프로그램의 특징을 관찰해보세요',
          '질문사항을 정리해서 현지 전문가에게 문의해보세요',
          '방문 후 한국 교육 현장에 적용할 수 있는 방안을 고민해보세요'
        ]
      },
      {
        title: `${location} - 미래 교육의 선도지`,
        description: `${location}은(는) 미래 교육의 방향을 제시하는 선도적인 교육 기관으로, 첨단 기술과 인문학적 가치를 결합한 혁신적인 교육 모델을 보여줍니다. 이곳의 교육 시스템은 학생들의 창의성과 비판적 사고를 키우는 데 중점을 두고 있어, 21세기 교육이 나아가야 할 방향을 명확히 제시합니다.

특히 이곳의 교육자들은 전통적인 교수법과 현대적 교육 기술을 조화롭게 활용하여, 학생들이 실제 문제를 해결할 수 있는 능력을 기를 수 있도록 돕습니다. 이러한 교육 철학과 실천은 연수 참가자들에게 새로운 교육 패러다임을 제시하며, 한국 교육 현장에 적용할 수 있는 구체적인 방안을 제공합니다.`,
        highlights: [
          '🚀 첨단 기술 - 미래 지향적 교육 도구',
          '🎨 인문학적 가치 - 인간 중심의 교육 철학',
          '🧠 창의적 사고 - 비판적 사고력 개발',
          '🔧 실무 중심 - 문제 해결 능력 향상',
          '🌐 글로벌 시각 - 국제적 교육 표준'
        ],
        tips: [
          '교육 기술과 도구의 활용 방법을 자세히 관찰해보세요',
          '교사들의 교육 철학과 실천 방법을 인터뷰해보세요',
          '학생들의 학습 과정과 결과물을 살펴보세요',
          '교육 시설과 환경의 특징을 기록해보세요',
          '한국 교육 현장에 적용 가능한 요소들을 정리해보세요'
        ]
      }
    ];

    // 랜덤하게 하나 선택
    const randomIndex = Math.floor(Math.random() * randomDescriptions.length);
    const selectedDescription = randomDescriptions[randomIndex];
    
    title = selectedDescription.title;
    description = selectedDescription.description;
    highlights = selectedDescription.highlights;
    tips = selectedDescription.tips;
  }

  return { title, description, highlights, tips };
}
