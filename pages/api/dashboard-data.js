import { db } from '../../firebaseConfig';
import { collection, getDocs, query, where } from 'firebase/firestore';

export default async function handler(req, res) {
  if (req.method === 'GET') {
    try {
      const { region } = req.query;
      
      if (!region) {
        return res.status(400).json({ success: false, error: 'regionì´ í•„ìš”í•©ë‹ˆë‹¤.' });
      }

      console.log('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìš”ì²­ - region:', region);

      const result = {
        schedules: [],
        participants: [],
        region: region
      };

      // 1. schedules ì»¬ë ‰ì…˜ì—ì„œ í•´ë‹¹ regionì˜ ë°ì´í„° ì°¾ê¸°
      try {
        const schedulesQuery = query(collection(db, 'schedules'));
        const schedulesSnapshot = await getDocs(schedulesQuery);
        
        // ëª¨ë“  schedules ë¬¸ì„œë¥¼ í™•ì¸í•˜ì—¬ í•´ë‹¹ regionì˜ ë°ì´í„° ì°¾ê¸°
        for (const doc of schedulesSnapshot.docs) {
          const data = doc.data();
          
          // region í•„ë“œê°€ ìˆëŠ” ê²½ìš°
          if (data.region) {
            if (data.region == region || data.region == String(region) || data.region == Number(region)) {
              console.log('Region ì¼ì¹˜í•˜ëŠ” ë¬¸ì„œ ë°œê²¬:', doc.id);
              
              // schedule ë°°ì—´ì´ ìˆëŠ” ê²½ìš°
              if (data.schedule && Array.isArray(data.schedule)) {
                result.schedules = data.schedule.map(item => ({
                  id: `${item.date}_${item.time}`,
                  date: item.date,
                  time: item.time,
                  activityName: item.activity,
                  location: item.location,
                  adminNotes: item.description || '',
                  type: 'normal',
                  hasResearchTask: item.activity?.includes('ì—°êµ¬') || item.activity?.includes('ê³¼ì œ') || false,
                  isMeal: item.activity?.includes('ì¡°ì‹') || item.activity?.includes('ì¤‘ì‹') || item.activity?.includes('ì„ì‹') || item.activity?.includes('ì•„ì¹¨') || item.activity?.includes('ì ì‹¬') || item.activity?.includes('ì €ë…') || false
                }));
              }
              
                             // participants ë°°ì—´ì´ ìˆëŠ” ê²½ìš°
               if (data.participants && Array.isArray(data.participants)) {
                 result.participants = data.participants.filter(participant => 
                   participant.name && 
                   !participant.name.includes('ë¶€ì¬') && 
                   (!participant.affiliation || !participant.affiliation.includes('ë¶€ì¬'))
                 ).sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ko'));
               }
              
              break; // ì²« ë²ˆì§¸ ì¼ì¹˜í•˜ëŠ” ë¬¸ì„œë¥¼ ì°¾ìœ¼ë©´ ì¤‘ë‹¨
            }
          }
        }
        
        console.log('ì²˜ë¦¬ëœ ì¼ì •:', result.schedules.length, 'ê°œ');
        console.log('ì²˜ë¦¬ëœ ì°¸ê°€ì:', result.participants.length, 'ê°œ');
        
      } catch (error) {
        console.error('Schedules ì¡°íšŒ ì˜¤ë¥˜:', error);
        return res.status(500).json({ success: false, error: 'ì¼ì • ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
      }

      // 2. ììœ ì‹œê°„ ìë™ ìƒì„±
      if (result.schedules.length > 0) {
        const schedulesByDate = {};
        
        // ë‚ ì§œë³„ë¡œ ì¼ì • ê·¸ë£¹í™”
        result.schedules.forEach(schedule => {
          if (!schedulesByDate[schedule.date]) {
            schedulesByDate[schedule.date] = [];
          }
          schedulesByDate[schedule.date].push(schedule);
        });
        
        // ê° ë‚ ì§œì˜ ë§ˆì§€ë§‰ ì¼ì • 1ì‹œê°„ í›„ì— ììœ ì‹œê°„ ì¶”ê°€
        Object.keys(schedulesByDate).forEach(date => {
          const daySchedules = schedulesByDate[date];
          
          // ì‹œê°„ìˆœ ì •ë ¬
          daySchedules.sort((a, b) => {
            const timeA = a.time || '00:00';
            const timeB = b.time || '00:00';
            return timeA.localeCompare(timeB);
          });
          
          // ë§ˆì§€ë§‰ ì¼ì • 1ì‹œê°„ í›„ì— ììœ ì‹œê°„ ì¶”ê°€
          if (daySchedules.length > 0) {
            const lastSchedule = daySchedules[daySchedules.length - 1];
            const lastTime = lastSchedule.time || '18:00';
            
            // ì‹œê°„ì„ ë¶„ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ 1ì‹œê°„ ì¶”ê°€
            const [hours, minutes] = lastTime.split(':').map(Number);
            const freeTimeHours = hours + 1;
            const freeTime = `${freeTimeHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            
            result.schedules.push({
              id: `auto_free_${date}`,
              date: date,
              time: freeTime,
              activityName: 'ğŸ—“ï¸ ììœ ì¼ì •',
              location: 'ììœ  ì„ íƒ',
              type: 'free',
              adminNotes: 'ììœ ë¡œìš´ ì‹œê°„ì„ ë§Œë½í•´ë³´ì„¸ìš”!',
              autoGenerated: true
            });
          }
        });
        
        // ì „ì²´ ì¼ì •ì„ ë‚ ì§œ, ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
        result.schedules.sort((a, b) => {
          if (a.date !== b.date) {
            return a.date.localeCompare(b.date);
          }
          return a.time.localeCompare(b.time);
        });
      }

      res.status(200).json({
        success: true,
        data: result
      });

    } catch (error) {
      console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
      res.status(500).json({
        success: false,
        error: 'ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        details: error.message
      });
    }
  } else {
    res.setHeader('Allow', ['GET']);
    res.status(405).end(`Method ${req.method} Not Allowed`);
  }
} 